const BUNDLE_LINK_PREFIX="/a/loop_subscriptions/bundle",LOOP_BUNDLE_URL="https://api-service.loopwork.co/bundleTransaction/getBundleCartDetails",LOOP_API_SERVICE_URL="https://api-service.loopwork.co";let BUNDLE_CONTAINER_CLASS="BUNDLE_CONTAINER_CLASS",CART_SUBTOTAL_CLASS="CART_SUBTOTAL_CLASS";
const getItemsHtml=(a,b)=>{let c=a.quantity;b&&(b=b.find(d=>d.childProductId=a.id))&&(c=b.quantity);return`<p><span style="display:block;" class="data-cart-item-selling-plan-name">${a.title||""} x ${c||""}</span></p>`},getBundleCartTableTemplate=(a,b,c)=>`
        <tr class="cart-item" id="CartBundleItem-${b}">
    <td class="cart-item__media">
        <a href="${c}" class="cart-item__link" aria-hidden="true" tabindex="-1"> </a>
          <div class="cart-item__image-container gradient global-media-settings">
            <img src="${a.image||""}"  class="cart-item__image" alt="" loading="lazy" width="150" height="94">
          </div>
    </td>

    <td class="cart-item__details"><a href="" class="cart-item__name h4 break">${a.label}</a>
                <div class="product-option">
            ${a.items.map(d=>getItemsHtml(d)).join("")}
              <br/>
        </div>
        <div class="product-option">
         ${a.amount}
        </div><dl></dl>

        <p class="product-option">${a.sellingPlan||""}</p><ul class="discounts list-unstyled" role="list" aria-label="Discount"></ul>
    </td>

    <td class="cart-item__totals right medium-hide large-up-hide">
      <div class="cart-item__price-wrapper">
        <span class="price price--end">
             ${a.amount}
        </span>
      </div>
    </td>

    <td class="cart-item__quantity">
      <div class="cart-item__quantity-wrapper">
        <quantity-input class="quantity">
          <input disabled class="quantity__input" type="number" value="1" min="0">
        </quantity-input>
        <cart-remove-button>
          <a onclick="removeBundle('${a.bundleId}')" class="button button--tertiary" aria-label="${a.label}" style="cursor : pointer">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" aria-hidden="true" role="presentation" class="icon icon-remove">
                <path d="M14 3h-3.53a3.07 3.07 0 00-.6-1.65C9.44.82 8.8.5 8 .5s-1.44.32-1.87.85A3.06 3.06 0 005.53 3H2a.5.5 0 000 1h1.25v10c0 .28.22.5.5.5h8.5a.5.5 0 00.5-.5V4H14a.5.5 0 000-1zM6.91 1.98c.23-.29.58-.48 1.09-.48s.85.19 1.09.48c.2.24.3.6.36 1.02h-2.9c.05-.42.17-.78.36-1.02zm4.84 11.52h-7.5V4h7.5v9.5z" fill="currentColor"></path>
                <path d="M6.55 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5zM9.45 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5z" fill="currentColor"></path>
            </svg>
          </a>
        </cart-remove-button>
      </div>
    </td>

    <td class="cart-item__totals right small-hide">
      <div class="cart-item__price-wrapper"><span class="price price--end">
           ${a.amount}
          </span></div>
    </td>
  </tr>
    `,getBundleCartDrawerTemplate=(a,b,c)=>`
        <tr class="cart-item" id="CartBundleItem-${b}">
          <td class="cart-item__media" style="text-align:center;">
            <img class="cart-item__image" 
              src="${a.image||""}" 
              alt="${a.label}" loading="lazy" width="75" height="75">
          </td>
          <td class="cart-item__details">
            <a href="${c}" 
              class="cart-item__name break">
              ${a.label||""}
            </a>
            <dl>
              <div class="product-option">
                ${a.items.map(d=>getItemsHtml(d)).join("")}
                  <br/>
                  <p><span class="data-cart-item-selling-plan-name">
                    ${a.sellingPlan||""}
                  </span></p>
              </div>
            </dl>
          </td>
          <td class="cart-item__quantity small-hide">
            ${a.quantity}
          </td>
          <td class="right medium-hide large-up-hide">
            <div class="cart-item__price-wrapper medium-up" style="display: flex; gap: 10px;">
              <span class="price price--end" style="text-decoration:line-through;"> 
                ${a.priceWithoutDiscount} 
              </span>
              <span class="price price--end" style="font-weight: 600;">
                ${a.amount} 
              </span>
            </div>
            <div onclick="removeBundle('${a.bundleId}')" style="cursor:pointer; width: fit-content;height: 15px;display: inline-flex;flex-direction: row-reverse;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" style="width: 1em; height: 1em;" aria-hidden="true" focusable="false" role="presentation" class="icon icon-remove">
                    <path d="M14 3h-3.53a3.07 3.07 0 00-.6-1.65C9.44.82 8.8.5 8 .5s-1.44.32-1.87.85A3.06 3.06 0 005.53 3H2a.5.5 0 000 1h1.25v10c0 .28.22.5.5.5h8.5a.5.5 0 00.5-.5V4H14a.5.5 0 000-1zM6.91 1.98c.23-.29.58-.48 1.09-.48s.85.19 1.09.48c.2.24.3.6.36 1.02h-2.9c.05-.42.17-.78.36-1.02zm4.84 11.52h-7.5V4h7.5v9.5z" fill="currentColor"></path>
                    <path d="M6.55 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5zM9.45 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5z" fill="currentColor"></path>
              </svg>
            </div>
          </td>
        </tr>
    `,getBundleCartItemsDivTemplate=(a,b,c)=>`
        <div style="display:flex; gap:20px; justify-content: space-between;" id="CartBundleItem-${b}">
          <div style="display:flex; gap:20px;">
            <div style="text-align:center;">
              <img
                src="${a.image||""}" 
                alt="${a.label}" loading="lazy" width="75" height="75">
            </div>
            <div>
              <a href="${c}" 
                 style="font-weight:600">
                ${a.label||""}
              </a>
              <div>
                ${a.items.map(d=>getItemsHtml(d)).join("")}
                  <br/>
                  <p><span>${a.sellingPlan||""}</span></p>
              </div>
            </div>
          </div>
          <div>
            ${a.quantity}
          </div>
          <div>
            <div style="display: flex; gap: 10px;">
              <span style="text-decoration:line-through;"> 
               ${a.priceWithoutDiscount}
              </span>
              <span style="font-weight: 600;">${a.amount}</span>
            </div>
            <div onclick="removeBundle('${a.bundleId}')" style="cursor:pointer; vertical-align: text-top; width: fit-content;height: 15px;display: inline-flex;flex-direction: row-reverse;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" style="width: 1em; height: 1em;" aria-hidden="true" focusable="false" role="presentation" class="icon icon-remove">
                    <path d="M14 3h-3.53a3.07 3.07 0 00-.6-1.65C9.44.82 8.8.5 8 .5s-1.44.32-1.87.85A3.06 3.06 0 005.53 3H2a.5.5 0 000 1h1.25v10c0 .28.22.5.5.5h8.5a.5.5 0 00.5-.5V4H14a.5.5 0 000-1zM6.91 1.98c.23-.29.58-.48 1.09-.48s.85.19 1.09.48c.2.24.3.6.36 1.02h-2.9c.05-.42.17-.78.36-1.02zm4.84 11.52h-7.5V4h7.5v9.5z" fill="currentColor"></path>
                    <path d="M6.55 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5zM9.45 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5z" fill="currentColor"></path>
              </svg>
            </div>
          </div>
        </div>
    `,getPresetBundleCartTemplate=(a,b,c)=>`
        <tr class="cart-item" id="CartBundleItem-${b}">
    <td class="cart-item__media">
        <a href="${c}" class="cart-item__link" aria-hidden="true" tabindex="-1"> </a>
          <div class="cart-item__image-container gradient global-media-settings">
            <img src="${a.image||""}"  class="cart-item__image" alt="" loading="lazy" width="150" height="94">
          </div>
    </td>

    <td class="cart-item__details"><a href="${c}" class="cart-item__name h4 break">${a.label}</a>
                <div class="product-option">
            ${a.items.map(d=>getItemsHtml(d,a.bundleQuantityMapping)).join("")}
              <br/>
        </div>
        <div class="product-option">
         ${a.eachBundleAmount}
        </div><dl></dl>

        <p class="product-option">${a.sellingPlan||""}</p>
        ${a.discountTitle?`<ul class="discounts list-unstyled" role="list" aria-label="Discount">
            <li class="discounts__discount">
                <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-discount color-foreground-text" viewBox="0 0 12 12">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M7 0h3a2 2 0 012 2v3a1 1 0 01-.3.7l-6 6a1 1 0 01-1.4 0l-4-4a1 1 0 010-1.4l6-6A1 1 0 017 0zm2 2a1 1 0 102 0 1 1 0 00-2 0z" fill="currentColor">
                    </path>
                </svg>
                ${a.discountTitle}
            </li>
        </ul>`:""}
    </td>

    <td class="cart-item__totals right medium-hide large-up-hide">
      <div class="cart-item__price-wrapper"><span class="price price--end">
           ${a.amount}
          </span></div>
    </td>

    <td class="cart-item__quantity">
      <div class="cart-item__quantity-wrapper">
        <quantity-input class="quantity">
          <input disabled class="quantity__input" type="number" value="${a.bundleProductQuantity}" min="0">
        </quantity-input>
        <cart-remove-button>
          <a onclick="removeBundle('${a.bundleId}')" class="button button--tertiary" aria-label="${a.label}" style="cursor : pointer">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" aria-hidden="true" role="presentation" class="icon icon-remove">
                <path d="M14 3h-3.53a3.07 3.07 0 00-.6-1.65C9.44.82 8.8.5 8 .5s-1.44.32-1.87.85A3.06 3.06 0 005.53 3H2a.5.5 0 000 1h1.25v10c0 .28.22.5.5.5h8.5a.5.5 0 00.5-.5V4H14a.5.5 0 000-1zM6.91 1.98c.23-.29.58-.48 1.09-.48s.85.19 1.09.48c.2.24.3.6.36 1.02h-2.9c.05-.42.17-.78.36-1.02zm4.84 11.52h-7.5V4h7.5v9.5z" fill="currentColor"></path>
                <path d="M6.55 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5zM9.45 5.25a.5.5 0 00-.5.5v6a.5.5 0 001 0v-6a.5.5 0 00-.5-.5z" fill="currentColor"></path>
            </svg>
          </a>
        </cart-remove-button>
      </div>
    </td>

    <td class="cart-item__totals right small-hide">
      <div class="cart-item__price-wrapper"><span class="price price--end">
           ${a.amount}
          </span></div>
    </td>
  </tr>
    `,getItemKeysByBundleId=a=>{var b=window.Loop.bundleCartAllItems;const c={updates:{}};for(const d of b)(b=d?.properties?._bundleId??d?.properties?.bundleId)&&b===a&&(c.updates[d.key]=0);return c},removeBundle=async a=>{a=getItemKeysByBundleId(a);await fetch(`${window.Shopify.routes.root}cart/update.js`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});window.location.href=window.location.href},_getSelectedBundleVariants=a=>{var b=window.Loop.bundleCartAllItems;
let c="",d="";for(const e of b)(b=e?.properties?._bundleId??e?.properties?.bundleId)&&b===a&&(c+=`${e.id},`,d+=`${e.quantity},`);return{selectedVariants:c.substring(0,c?.length-1),selectedQuantities:d.substring(0,d?.length-1)}},_getLoopToken=async(a,b)=>(await (await fetch(`${LOOP_API_SERVICE_URL}/bundleTransaction/getToken?shopifyDomain=${a}&bundleTransactionId=${b}`)).json())?.token??"LOOP_TOKEN",editBundle=async a=>{console.log(`Editing bundle: ${a}`);const {selectedVariants:b,selectedQuantities:c}=
_getSelectedBundleVariants(a),d=await _getLoopToken(window?.Shopify?.shop,a);window.location.href=`${BUNDLE_LINK_PREFIX}/change/${a}?loop_token=${d}&selectedVariants=${b}&selectedQuantities=${c}`},fetchBundleTransactionCartDetails=async a=>await (await fetch(`${LOOP_BUNDLE_URL}/${a}`)).json(),addExtraDetailsToBundleItems=async a=>{let b=0;var c="";let d="";for(let f=0;f<a.length;++f){var e=a[f].bundleId;const g=await fetchBundleTransactionCartDetails(e);e=g?.variantMap?.[e]??[];const k=a[f].isPresetBundleProduct;
let h=k?a[f].discounted_price:a[f].price;a[f].label=g?.label;a[f].image=g?.image;a[f].sellingPlan=g?.name;a[f].priceWithoutDiscount=`${g.currencySymbol}${h.toFixed(2)}`;c=a[f].items.reduce((l,m)=>l+m.quantity,0);g.discountType&&g.discountValue&&!k&&("PERCENTAGE"===g.discountType?g.appliesOnEachItem?(b+=h*(parseFloat(g.discountValue)/100)*c,h-=h*(parseFloat(g.discountValue)/100)*c):(b+=h*(parseFloat(g.discountValue)/100),h-=h*(parseFloat(g.discountValue)/100)):g.appliesOnEachItem?(b+=parseFloat(g.discountValue)*
c,h-=parseFloat(g.discountValue)*c):(b+=parseFloat(g.discountValue),h-=parseFloat(g.discountValue)));a[f].price=`${g.currencySymbol}${parseFloat(h).toFixed(2)}`;a[f].amount=`${g.currencySymbol}${parseFloat(h).toFixed(2)}`;a[f].loopBundleId=g.loopBundleId;c=g.currencySymbol;d=g.currency;g?.productsQuantity?(a[f].bundleProductQuantity=g.productsQuantity,a[f].eachBundleAmount=`${g.currencySymbol}${parseFloat(h/g.productsQuantity).toFixed(2)}`):(a[f].bundleProductQuantity=1,a[f].eachBundleAmount=`${g.currencySymbol}${parseFloat(h/
1).toFixed(2)}`);e.length&&(a[f].bundleQuantityMapping=e);k&&(a[f].productHandle=g.product_handle)}removeDiscountFromSubtotalInCart(b,c,d)},removeDiscountFromSubtotalInCart=(a,b,c)=>{let d;(d=document.querySelector(".totals__subtotal-value"))&&applyDiscountByCartLineItems(d,a,b,c)};
function applyDiscountByCartLineItems(a,b,c,d){b=((window.Loop.bundleCartAllItems.reduce((e,f)=>e+(f.properties._isPresetBundleProduct?f.discounted_price:f.price)*f.quantity,0)/100).toFixed(2)-b).toFixed(2);isNaN(b)||(a.innerHTML=`${c??""}${b} ${d??""}`)}
function applyDiscountBySubtotal(a,b){var c=a.innerHTML.match(/[\d,.]+/);c&&1===c.length?(c=parseFloat(c[0].replace(/,/g,"")),isNaN(c)?console.log("Invalid price format"):((c-b).toLocaleString("en",{minimumFractionDigits:2}),a.innerHTML=updatedHtml)):console.log("Invalid price format")}
const getBundleItems=a=>{const b={};for(const c of a)if(a=c?.properties?._bundleId??c?.properties?.bundleId)Object.hasOwn(b,a)?(b[a].price+=Number(c.price)*Number(c.quantity)/100,b[a].discounted_price+=Number(c.discounted_price)*Number(c.quantity)/100,b[a].amount+=Number(c.price)*Number(c.quantity)/100,b[a].items.push(c)):b[a]={bundleId:a,quantity:1,price:Number(c.price)*Number(c.quantity)/100,amount:Number(c.price)*Number(c.quantity)/100,items:[c],discounted_price:Number(c.discounted_price)*Number(c.quantity)/
100,isPresetBundleProduct:c?.properties?._isPresetBundleProduct,discountTitle:c?.discounts?.[0]?.title??""};return Object.values(b)},renderBundleItems=(a,b)=>{let c=document.querySelector(`.${b}`);parent||(c=document.querySelector(`.${BUNDLE_CONTAINER_CLASS}`));for(let e=0;e<a.length;++e){var d=a[e].isPresetBundleProduct?`https://${window.Shopify.shop}/${a[e].productHandle}`:`${BUNDLE_LINK_PREFIX}/${a[e].loopBundleId}`;let f=document.getElementsByTagName("table");d=a[e].isPresetBundleProduct?getPresetBundleCartTemplate(a[e],
e+1,d):b.includes("drawer")&&f.length?getBundleCartDrawerTemplate(a[e],e+1,d):f.length?getBundleCartTableTemplate(a[e],e+1,d):getBundleCartItemsDivTemplate(a[e],e+1,d);c.innerHTML=`${d} ${c.innerHTML}`}};async function getCartItems(){return(await (await fetch(`https://${Shopify.shop}/cart.json`)).json())?.items??[]}
function setupMutationNew(){if(!window.location.pathname.includes("/a/loop_subscriptions/bundle")){var a=window.Loop.bundleCartAllItems.reduce((e,f)=>e+f.quantity,0),b,c=async()=>{(await getCartItems()).reduce((e,f)=>e+f.quantity,0)!==a&&window.location.reload()},d={childList:!0,subtree:!0};document.querySelectorAll("form").forEach(e=>{(new MutationObserver(()=>{clearTimeout(b);b=setTimeout(c,500)})).observe(e,d)})}}
function setupMutationIfElementDelete(){let a=!0,b;const c=()=>{a?a=!1:window.location.pathname.includes("/a/loop_subscriptions/bundle")||(a=!0,window.location.reload())};let d=document.querySelector(".cart-container");d||=document.querySelector(".cart__blocks");d&&(new MutationObserver(()=>{clearTimeout(b);b=setTimeout(c,1E3)})).observe(d,{childList:!0,subtree:!0})}
function setupMutation(){var a=!0,b=null;b=null;(b=(b=document.querySelectorAll("[data-cart-subtotal]"))&&1<b.length||!b.length?document.querySelector(`.${CART_SUBTOTAL_CLASS}`):b[0])&&(new MutationObserver((c,d)=>{a?a=!1:(a=!0,setTimeout(window.location.reload(),1E3))})).observe(b,{attributes:!0,childList:!0,subtree:!0})}
const bootstrap=async a=>{console.log(`Loop Bundle Initialized for ${a}`);try{var b=await (await fetch(`https://snippets.loopwork.co/bundle/${Shopify.shop}/${Shopify.theme.id}.json`)).json()||{};Object.keys(b).length&&(BUNDLE_CONTAINER_CLASS=b.cartContainerClass,CART_SUBTOTAL_CLASS=b.cartSubtotalClass)}catch(c){console.log("Error fetching loop bundle classes")}setupMutationNew();b=getBundleItems(window.Loop.bundleCartAllItems);await addExtraDetailsToBundleItems(b);renderBundleItems(b,a)};
