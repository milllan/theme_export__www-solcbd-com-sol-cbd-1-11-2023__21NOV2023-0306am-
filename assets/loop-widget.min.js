const APP_ID="5284869",CREATE_BUNDLE_TRANSACTION_API="https://api-service.loopwork.co/bundleTransaction",FILTER_BUNDLE_SP_API="https://apiv2.loopwork.co/bundleStorefront/filterBundleSellingPlanIds",GET_PRODUCT_BUNDLE_DATA_API="https://apiv2.loopwork.co/bundleStorefront/getChildVariants?id=",PRODUCT_QUANTITY_SELECTOR=".quantity__input",productDataClass="loopProductQuickJson",loopSubscriptionContainerId="loop-subscription-container",oneTimePurchaseOptionClass="loop-one-time-purchase-option",subscriptionGroupClass=
"loop-subscription-group",purchaseOptionName="loop_purchase_option",sellingPlanSelectorClass="loop-selling-plan-selector";
async function main(a){try{log(`start application: ${a}`);const b=getProductData(a);setupDomListeners(a);initializeWindowLoopProps();const c=getLoopSellingPlanGroups(b?.selling_plan_groups);b.selling_plan_groups=c;const d=getLoopProductVariants(b.variants,c);b.variants=d;window.loopProps[a]={product:b};await setLoopUIProperties(Shopify.shop);showSellingPlanFieldset(a);showLoopPurchaseOptionsLabel(a);initializeLoopUI(b);await processBundleProduct(a);listenLoopCustomEvent();await getBundleSpgs(a);displayLoopWidget(a);
observeFormChanges(b)}catch(b){logError(b)}}
function setupDomListeners(a){log(`setup dom listeners for ${a}`);var b=getLoopSubscriptionContainer(a);const c=b.querySelectorAll(`.${oneTimePurchaseOptionClass}`),d=b.querySelectorAll(`.${subscriptionGroupClass}`),f=b.querySelectorAll(`input[name=${purchaseOptionName}]`);b=b.querySelectorAll(`.${sellingPlanSelectorClass}`);for(const g of c)g.addEventListener("click",clickOnSellingPlanGroupContainer);for(const g of d)g.addEventListener("click",clickOnSellingPlanGroupContainer);for(const g of f)g.addEventListener("click",
changeInSellingPlanGroupLoop);for(const g of b)g.addEventListener("change",changeInDeliveryOptionLoop);log(`setup dom listeners complete for ${a}`)}function initializeWindowLoopProps(){window.loopProps||(window.loopProps={})}function getLoopSellingPlanGroups(a){return Array.isArray(a)?a.filter(b=>b.app_id===APP_ID):[]}
function getLoopProductVariants(a,b){const c=new Set(b.map(d=>d.id));return a.map(d=>({...d,selling_plan_allocations:d.selling_plan_allocations.filter(f=>c.has(f.selling_plan_group_id))}))}async function setLoopUIProperties(a){a=await fetchLoopUIProperties(a);window.loopPropsUI={...a}}async function fetchLoopUIProperties(a){log(`fetch loop subscription UI props: ${a}`);return await (await fetch(`https://d217z8zw4dqir.cloudfront.net/${a}.json`)).json()??{}}
function showSellingPlanFieldset(a){(a=getLoopSubscriptionContainer(a).querySelector("#loop-selling-plan-fieldset"))&&a.classList.remove("loop-display-none","loop-display-none-by-variant")}function showLoopPurchaseOptionsLabel(a){if(a=getLoopSubscriptionContainer(a).querySelectorAll(".loop-purchase-options-label"))for(const b of a)b.classList.remove("loop-display-none","loop-display-none-by-variant")}
function initializeLoopUI(a){let b=getVariantIdFromURL(a.variants);b||=getFirstAvailableVariantVariantId(a.id);loopInit({productId:a.id,product:a,variantId:b})}function getVariantIdFromURL(a){const b=(new URL(document.URL)).searchParams.get("variant")||"";return(new Set(a?.map(c=>c.id))).has(Number(b))?b:null}function getFirstAvailableVariantVariantId(a){return getProductData(a)?.variants.find(b=>b.available)?.id}
function displayLoopWidget(a){(a=getLoopSubscriptionContainer(a))&&a.classList.remove("loop-display-none")}
function observeFormChanges(a){document.querySelectorAll("form").forEach(b=>{const c=b.querySelector('[name="id"]'),d=b.querySelector('[name="loop_variant_id"]');d&&c?.value&&(d.value=c.value);const f=new Set(a?.variants?.map(g=>g.id));c?.value&&f.has(Number(c?.value))&&(new MutationObserver((g,e)=>{g=c?.value??"";e=d?.value??"";g&&d&&g!==e&&(d.value=g,variantChanged({loopProduct:a,variantId:g}))})).observe(b,{attributes:!0,childList:!0,subtree:!0})})}
const loopPriceSelectors='.price:not(.price--on-sale) .price__regular .price-item--regular;.price.price--on-sale .price__sale .price-item--sale;.product-single__prices .product__price:not(.product__price--compare);.product-pricing .product--price .price--main .money;[data-zp-product-discount-price];.product-single__header .product__price;.modal_price .current_price;.product-area__col--price .current-price.theme-money;[data-product-type="price"][data-pf-type="ProductPrice"];.product__price .fs-heading-4-base[data-price];#product-price .money[data-product-price];#ProductPrice;.product-single__price;.price:not(.price--on-sale) span.price-item--regular;.product-price .price .money:not(.original);.price-box #price .price;.product__price span[data-product-price];.product-form--price-wrapper .product-form--price;.product-page--pricing--variant-price #price-field;.price-reviews .product-price'.split(";"),arrToInstanceCountObj=
a=>a.reduce((b,c)=>{b[c]=(b[c]||0)+1;return b},{});function findSelectedVariantLoop(a,b){const c=getProductFromLoopProps(a)||getProductData(a);a=determineSelectedVariantId(b,a,c);return findVariantById(c,a)}function getProductFromLoopProps(a){return window.loopProps?.[a]?.product}function determineSelectedVariantId(a,b,c){return a?a:window.loopProps?.[b]?.selectedVariantId?window.loopProps[b].selectedVariantId:c.variants?.[0]?.id}
function findVariantById(a,b){return a.variants?.find(c=>Number(c.id)===Number(b))}function defaultSelectFirstSellingPlanLoop(a,b){let c=!0;(getLoopSubscriptionContainer(b).querySelectorAll("input[name=loop_purchase_option]")||[]).forEach(d=>{Number(d.dataset.variantId)===Number(a.id)&&c&&(c=!1,d.checked=!0,setTimeout(()=>{if(isTouchDevice()){const {dataset:f}=d;changeInSellingPlanGroupLoopMobile(f.id,f.name,f.productId)}d.click()},300))})}
function hideLoopPurchaseOptionsLabel(a){if(a=getLoopSubscriptionContainer(a).querySelectorAll(".loop-purchase-options-label"))for(const b of a)b.classList.add("loop-display-none","loop-display-none-by-variant")}function addLoopPurchaseOptionLabelText(a){(a=getLoopSubscriptionContainer(a).querySelectorAll(".loop-purchase-options-label"))&&a.forEach(b=>{b&&(b.innerHTML=`${window.loopPropsUI.loopPurchaseOptionslabel||"Purchase Options"}`)})}
function addLoopOneTimePurchaseOptionLabelText(a){(a=getLoopSubscriptionContainer(a).querySelectorAll(".loop-one-time-purchase-option-label"))&&a.forEach(b=>{b&&(b.innerHTML=`${window.loopPropsUI.loopOneTimePurchaselabel||"One time Purchase"}`)})}
function showOneTimePurchaseOptionAtBottom(a){a=getLoopSubscriptionContainer(a);const b=a.querySelector("#loop-one-time-purchase-option-at-top"),c=a.querySelector("#loop-one-time-purchase-option-at-bottom");b&&c&&b.innerHTML&&(c.innerHTML=b.innerHTML,b.innerHTML="");a.querySelectorAll(".loop-subscription-group").forEach(d=>{d.classList.remove("loop-subscription-group-border-top");d.classList.add("loop-subscription-group-border-bottom")})}
function hideEachLabelForPrice(){[".loop-subscription-group-price-quantity",".loop-one-time-purchase-option-price-quantity"].forEach(a=>{document.querySelectorAll(a).forEach(b=>{b.classList.add("loop-display-none")})})}
function displayTooltip(a){a=getLoopSubscriptionContainer(a);var b=a.querySelector("#loop-tooltip");b&&(b.classList.remove("loop-display-none"),updateTooltipContent(a,"#loop-tooltip-label",window.loopPropsUI.subscriptionPopupLabel),updateTooltipContent(a,"#loop-tooltip-description",window.loopPropsUI.subscriptionPopupDescription),b=a.querySelector("#loop-tooltip-label"),a=a.querySelector("#loop-tooltip-description"),b&&a&&(b.style.fill=window.getComputedStyle(a).color))}
function updateTooltipContent(a,b,c){(a=a.querySelector(b))&&c&&(a.innerHTML=c)}function hideTooltip(a){(a=getLoopSubscriptionContainer(a).querySelector("#loop-tooltip"))&&a.classList.add("loop-display-none")}
function addExtraLoopStyles(){if(window&&window.loopPropsUI&&window.loopPropsUI.style){let b={purchase_option_label:[".loop-purchase-options-label"],widget_feildset:[".loop-selling-plan-fieldset"],selling_plan_group_container:[".loop-one-time-purchase-option",".loop-subscription-group"],selling_plan_group_label:[".loop-one-time-purchase-option-label",".loop-subscription-group-label"],selling_plan_label:[".loop-selling-plan-selector-label"],selling_plan_selector:[".loop-selling-plan-selector"],selling_plan_price_label:[".loop-one-time-purchase-option-price-amount",
".loop-subscription-group-price-amount"],selling_plan_price_subtitle_label:[".loop-one-time-purchase-option-price-quantity",".loop-subscription-group-price-quantity"],selling_plan_description_label:[".loop-selling-plan-selector-description"],selling_plan_discount_badge_style:[".loop-subscription-group-discount-badge"],subscription_details_label:[".loop-tooltip-label"],subscription_details_popup:[".loop-tooltiptext",".loop-container-arrow",".loop-tooltip-description"],selling_plan_group_selected:[".loop-selected-selling-plan-group"],
selling_plan_group_radio:[".loop-subscription-group-radio",".loop-one-time-purchase-option-radio"]};const c=({data:g})=>{if(g){let e="";Object.keys(g).forEach(h=>{e=` ${e} ${h}: ${g[h]} !important;`});return e}return""},d=({id:g})=>b[g]||[];let f="";var {style:a}=window.loopPropsUI;a.map(g=>{d(g).map(e=>{f+=`
                 ${e} {
                     ${c(g)}
                 }
             `})});(a=document.querySelectorAll(".loop-style"))&&a.forEach(g=>{g.innerHTML=`${g.innerHTML}
                 ${f}
             `})}window&&window.loopPropsUI&&window.loopPropsUI.cssClassess&&(a=document.querySelectorAll(".loop-style"))&&a.forEach(b=>{b.innerHTML=`${b.innerHTML}
                 ${window.loopPropsUI.cssClassess}
             `})}function hideSellingPlanFieldset(a){(a=getLoopSubscriptionContainer(a).querySelector("#loop-selling-plan-fieldset"))&&a.classList.add("loop-display-none","loop-display-none-by-variant")}
function applySettings({productId:a}){var b=window.loopProps[a].product;const c=findSelectedVariantLoop(a);window&&window.loopPropsUI&&!1===window.loopPropsUI.displayLoopPurchaseOptionLabel&&hideLoopPurchaseOptionsLabel(a);window&&window.loopPropsUI&&window.loopPropsUI.loopPurchaseOptionslabel&&addLoopPurchaseOptionLabelText(a);window&&window.loopPropsUI&&window.loopPropsUI.loopOneTimePurchaselabel&&addLoopOneTimePurchaseOptionLabelText(a);window&&window.loopPropsUI&&window.loopPropsUI.displayOneTimePurchaseOptionAtBottom&&
(showOneTimePurchaseOptionAtBottom(a),getLoopSubscriptionContainer(a).querySelectorAll(".loop-one-time-purchase-option").forEach(f=>{f.addEventListener("click",clickOnSellingPlanGroupContainer)}),getLoopSubscriptionContainer(a).querySelectorAll("input[name=loop_purchase_option]").forEach(f=>{f.addEventListener("click",changeInSellingPlanGroupLoop)}));window&&window.loopPropsUI&&!1===window.loopPropsUI.displayEachLabelForPrice&&hideEachLabelForPrice();if(window&&window.loopPropsUI&&window.loopPropsUI.hidePlanSelectorIfOnlyOne){var {availableSellingPlanAllocations:d=
[]}=window.loopProps[a];let f=[];d.map(e=>{f.push(e.selling_plan_group_id)});let g=arrToInstanceCountObj(f);Object.keys(g).forEach(e=>{if(1===g[e]){var h=document.querySelector(`#loop-selling-plan-container-${c.id}-${e}`);if(h){let k=h.querySelector(".loop-selling-plan-selector-label");e=h.querySelector(`#loop-selling-plan-first-delivery-options-${c.id}-${e}`);h=h.querySelector(".loop-selling-plan-selector");k&&k.classList.add("loop-display-none");e&&e.classList.add("loop-display-none");h&&h.classList.add("loop-display-none")}}})}if(window&&
window.loopPropsUI&&window.loopPropsUI.showPlanSelectorAsTextIfOnlyOnePlan&&!window.loopPropsUI.hidePlanSelectorIfOnlyOne){({availableSellingPlanAllocations:d=[]}=window.loopProps[a]);let f=[];d.map(e=>{f.push(e.selling_plan_group_id)});let g=arrToInstanceCountObj(f);Object.keys(g).forEach(e=>{if(1===g[e]){var h=`#loop-selling-plan-first-delivery-options-${c.id}-${e}`;(h=document.querySelector(h))&&h.classList&&h.classList.remove("loop-display-none");h=`#loop-select-${c.id}-${e}`;(h=document.querySelector(h))&&
h.classList.add("loop-display-none")}})}window&&window.loopPropsUI&&window.loopPropsUI.hideWholeWidgetIfOnlyOnePlan&&b.requires_selling_plan&&c.selling_plan_allocations&&1===c.selling_plan_allocations.length&&(hideSellingPlanFieldset(a),hideLoopPurchaseOptionsLabel(a));if(window&&window.loopPropsUI&&window.loopPropsUI.hideRadioButtonIfOnlyOnePlan&&b.requires_selling_plan){({availableSellingPlanAllocations:d}=window.loopProps[a]);let f=[];d.map(e=>{f.push(e.selling_plan_group_id)});d=arrToInstanceCountObj(f);
let g=!1;if(g=1===Object.keys(d).length?!0:!1)(d=getLoopSubscriptionContainer(a).querySelectorAll(".loop-subscription-group-radio"))&&d.forEach(e=>{e.classList.add("loop-display-none")}),(d=getLoopSubscriptionContainer(a).querySelectorAll(".loop-subscription-group-selling-plans-container"))&&d.forEach(e=>{e.classList.add("loop-left-margin-0")})}addExtraLoopStyles();window&&window.loopPropsUI&&window.loopPropsUI.displaySubscriptionPopup&&c&&c.selling_plan_allocations&&c.selling_plan_allocations.length?
displayTooltip(a):hideTooltip(a);b&&b.requires_selling_plan&&Array.isArray(c.selling_plan_allocations)&&c.selling_plan_allocations.length&&(b=`#loop-product-variant-${c.id}`,b=getLoopSubscriptionContainer(a).querySelector(b),window&&window.loopPropsUI&&window.loopPropsUI.displayOneTimePurchaseOptionAtBottom?(b=b.querySelectorAll(".loop-subscription-group"))&&b.length&&(b=b[b.length-1],b.style.borderBottom="0",b.classList.remove("loop-subscription-group-border-bottom")):(b=b.querySelectorAll(".loop-subscription-group"))&&
b.length&&(b=b[0],b.style.borderTop="0",b.classList.remove("loop-subscription-group-border-top")));window&&window.loopPropsUI&&window.loopPropsUI.displayDiscountBadge?displayDiscountBadge({productId:a}):(a=document.querySelectorAll(".loop-subscription-group-discount-badge"))&&a.forEach(f=>{f&&f.classList.add("loop-display-none")});if(window&&window.loopPropsUI&&window.loopPropsUI.translationData){let f=window.loopPropsUI.translationData||{},g={widget_price_label_text:[".loop-one-time-purchase-option-price-quantity",
".loop-subscription-group-price-quantity"]};Object.keys(g).forEach(e=>{f&&f[e]&&g[e].map(h=>{(h=document.querySelectorAll(h))&&h.forEach(k=>{k.innerText=f[e]})})})}}function clickOnSellingPlanGroupContainer(a){if(a=a.target.closest(".loop-subscription-group")||a.target.closest(".loop-one-time-purchase-option"))a=a.querySelector('input[type="radio"]'),a?.dataset?.id!==window.loopProps[a.dataset.productId]?.sellingPlanGroupId&&a.click()}
function variantChanged({loopProduct:a,variantId:b}){loopInit({productId:a.id,product:JSON.parse(JSON.stringify(a)),variantId:b})}function checkVariantsSellingPlanAllocation(a,b){0<a?.selling_plan_allocations?.length?(showSellingPlanFieldset(b),showLoopPurchaseOptionsLabel(b)):(hideSellingPlanFieldset(b),hideLoopPurchaseOptionsLabel(b))}
function defaultSelectOneTimePurchaseOption(a,b){const c=getLoopSubscriptionContainer(b).querySelector(`#loop-one-time-purchase-${b}`);c?(c.checked=!0,c.click(),isTouchDevice()&&({dataset:a}=c,changeInSellingPlanGroupLoopMobile(a.id,a.name,a.productId))):defaultSelectFirstSellingPlanLoop(a,b)}
function loopInit({productId:a,product:b,variantId:c}){updateLoopProperties({product:b,productId:a,variantId:c});c=findSelectedVariantLoop(a,c);toggleVariantDisplay(b,c.id);checkVariantsSellingPlanAllocation(c,a);applyDefaultSelectionBasedOnSettings(c,a);applySettings({productId:a})}function toggleVariantDisplay(a,b){a.variants.forEach(c=>{const d=c.id===b?"block":"none";document.querySelector(`#loop-product-variant-${c.id}`).style.display=d})}
function applyDefaultSelectionBasedOnSettings(a,b){window.loopPropsUI?.byDefaultChooseSubscriptionOption?defaultSelectFirstSellingPlanLoop(a,b):defaultSelectOneTimePurchaseOption(a,b)}function updateSelectDropDownDefaultValues({productId:a,variant:b,sellingPlanGroupId:c}){a=window.loopProps[a].product.selling_plan_groups;Array.isArray(a)&&a.length&&a.forEach(d=>{c!==d.id&&resetSelectDropdown(b.id,d.id)})}
function resetSelectDropdown(a,b){if(a=document.getElementById(`loop-select-${a}-${b}`))a.options[0].selected=!0}
function changeInSellingPlanGroupLoopMobile(a,b,c){var d=findSelectedVariantLoop(c,window.loopProps[c].selectedVariantId),f=d.selling_plan_allocations.filter(g=>g.selling_plan_group_id===a)||[];f=f&&f.length?f[0]:{};updateLoopProperties({productId:c,variantId:d.id,sellingPlanGroupId:a,sellingPlanGroupName:b,sellingPlanId:f.selling_plan_id,sellingPlan:f});updateSelectDropDownDefaultValues({productId:c,variant:d,sellingPlanGroupId:a});updatePriceInParentElements({productId:c});updateSellingPlanDescriptionUI({productId:c});
displayDiscountBadge({productId:c});updateCartButtonText({productId:c});updatePriceInUI({productId:c});applyBundleDiscount(c);checkAllowCheckoutIfBundle(c);(b=getLoopSubscriptionContainer(c).querySelectorAll(".loop-selected-selling-plan-group"))&&b.forEach(g=>{g&&g.classList.remove("loop-selected-selling-plan-group")});"loop-one-time-purchase"===a?(c=getLoopSubscriptionContainer(c).querySelectorAll(".loop-one-time-purchase-option"))&&c.forEach(g=>{g.classList.add("loop-selected-selling-plan-group")}):
(d=`#loop-${d.id}-${a}`,(c=getLoopSubscriptionContainer(c).querySelector(d))&&c.classList.add("loop-selected-selling-plan-group"))}
function changeInSellingPlanGroupLoop(a){let b=a.target.dataset.id,c=a.target.dataset.name;var d=a.target.dataset.productId,f=findSelectedVariantLoop(d,window.loopProps[d].selectedVariantId),g=f.selling_plan_allocations.filter(e=>e.selling_plan_group_id===b)||[];g=g&&g.length?g[0]:{};updateLoopProperties({productId:d,variantId:f.id,sellingPlanGroupId:b,sellingPlanGroupName:c,sellingPlanId:g.selling_plan_id,sellingPlan:g});updateSelectDropDownDefaultValues({productId:d,variant:f,sellingPlanGroupId:a.target.dataset.id});
updatePriceInParentElements({productId:d});updateSellingPlanDescriptionUI({productId:d});displayDiscountBadge({productId:d});updateCartButtonText({productId:d});updatePriceInUI({productId:d});applyBundleDiscount(d);checkAllowCheckoutIfBundle(d);(a=getLoopSubscriptionContainer(d).querySelectorAll(".loop-selected-selling-plan-group"))&&a.forEach(e=>{e&&e.classList.remove("loop-selected-selling-plan-group")});"loop-one-time-purchase"===b?(d=getLoopSubscriptionContainer(d).querySelectorAll(".loop-one-time-purchase-option"))&&
d.forEach(e=>{e.classList.add("loop-selected-selling-plan-group")}):(f=`#loop-${f.id}-${b}`,(d=getLoopSubscriptionContainer(d).querySelector(f))&&d.classList.add("loop-selected-selling-plan-group"))}
function changeInDeliveryOptionLoop(a){let b=a.target.dataset.productId;updateLoopProperties({productId:b,sellingPlanId:a.target.value});updatePriceInParentElements({productId:b});updateSellingPlanDescriptionUI({productId:b});displayDiscountBadge({productId:b});updatePriceInUI({productId:b});applyBundleDiscount(b);checkAllowCheckoutIfBundle(b)}
function displayDiscountBadge({productId:a}){const b=findSelectedVariantLoop(a),{selling_plan_groups:c}=window.loopProps[a].product;window&&window.loopProps&&window.loopPropsUI.displayDiscountBadge?c.map(d=>{const {selling_plans:f}=d;let g=[];f.map(k=>{({price_adjustments:k}=k);k=k.length?k[0]:{};g.push({value:k.value,value_type:k.value_type,amount:"fixed_amount"===k.value_type?k.value:Number(b.price)*k.value/100})});let e=g.reduce((k,l)=>k.amount>l.amount?k:l);var h=`#loop-discount-badge-${b.id}-${d.id}`;
h=getLoopSubscriptionContainer(a).querySelector(h);window.loopProps[a]&&d.id===window.loopProps[a].sellingPlanGroupId&&(e=(f.find(k=>k.id===Number(window.loopProps[a].sellingPlanId))||{}).price_adjustments[0]);h&&(d="",e&&"fixed_amount"===e.value_type?d=loopFormatMoney(e.value,!0):e&&"percentage"===e.value_type&&(d=`${e.value}%`),d=(window?.loopPropsUI?.discountBadgeText||" ").replace("{discount_value}",d),h.innerHTML=`${d}`,e?.value||Number(e?.value)?h.classList.remove("loop-display-none"):h.classList.add("loop-display-none"))}):
c.map(d=>{(d=document.querySelector(`#loop-discount-badge-${b.id}-${d.id}`))&&d.classList.add("loop-display-none")})}function calculateCurrentSellingPlanLoop({productId:a,availableSellingPlanAllocations:b}){const {sellingPlanId:c,sellingPlanGroupId:d}=window.loopProps[a];return b.find(f=>f.selling_plan_group_id!==d?!1:c?Number(f.selling_plan_id)===Number(c):!0)||{}}
function updateLoopProperties({product:a,productId:b,variantId:c,sellingPlanGroupId:d,sellingPlanGroupName:f,sellingPlanId:g}){var e=getLoopSubscriptionContainer(b).querySelector("#loop-selling-plan-fieldset");c&&(Number(c)!==Number(e.dataset.selectedVariantId)&&(e.dataset.sellingPlanGroupId="",e.dataset.sellingPlanGroupName="",e.dataset.sellingPlanId=""),e.dataset.selectedVariantId=c);d&&(e.dataset.sellingPlanGroupId=d);f&&(e.dataset.sellingPlanGroupName=f);a&&(e.dataset.product=JSON.stringify(a));
g?e.dataset.sellingPlanId=g:"loop-one-time-purchase"===d&&(e.dataset.sellingPlanId="",e.dataset.sellingPlan={},e.dataset.sellingPlan={});window.loopProps||(window.loopProps={},window.loopProps[b]={product:a,productId:b});a=window.loopProps[b].productBundleData;window.loopProps[b]={...e.dataset,productId:b};window.loopProps[b].productBundleData=a;e.dataset&&e.dataset.product&&(window.loopProps[b]={...window.loopProps[b],product:JSON.parse(window.loopProps[b].product)});e=(a=findSelectedVariantLoop(b))&&
Array.isArray(a.selling_plan_allocations)?a.selling_plan_allocations:[];window.loopProps[b].availableSellingPlanAllocations=e;window.loopProps[b].variant=a;a=calculateCurrentSellingPlanLoop({availableSellingPlanAllocations:e,productId:b});let h=a.selling_plan_id||"";window.loopProps[b].sellingPlan=a;e=e.find(k=>{if(h&&Number(k.selling_plan_id)===Number(h))return!0});window.loopProps[b].sellingPlanAllocation=e;({selling_plan_groups:e}=window.loopProps[b].product);window.loopProps[b].sellingPlanDefination=
{};window.loopProps[b].sellingPlanPriceAdjustments=[];e&&Array.isArray(e)&&e.map(k=>{k.id===window.loopProps[b].sellingPlanGroupId&&({selling_plans:k}=k,k.map(l=>{l.id===Number(window.loopProps[b].sellingPlanId)&&(window.loopProps[b].sellingPlanDefination=l,window.loopProps[b].sellingPlanPriceAdjustments=l.price_adjustments)}))});if(e=getLoopSubscriptionContainer(b).querySelector('[name="selling_plan"]'))e.value=h;document.querySelectorAll(`form[data-loop-product-id="${b}"]`).forEach(k=>{var l=k.querySelector('input[name="selling_plan"]');
l&&l.remove();l=document.createElement("input");l.type="hidden";l.name="selling_plan";l.value=h;k.appendChild(l)});hideBundleSPG(b)}function updateCartButtonText({productId:a}){var b=document.querySelector(`[data-loop-product-id="${a}"]`)||document;const c=determineOneTimeOrder(a);if(b=getAddToCartButton(b))a=getButtonText(c,a),updateButtonInnerHTML(b,a)}function determineOneTimeOrder(a){a=window?.loopProps[a]?.sellingPlanGroupId;return!a||"loop-one-time-purchase"===a}
function getAddToCartButton(a){let b=null;["button[type='submit'][name='add']","button[type='button'][name='add']"].map(c=>{b||=a.querySelector(c)});return b}
function getButtonText(a,b){return a?window.loopProps[b].variant.available?window?.loopPropsUI?.translationData?.widget_add_to_cart_button_for_one_time_purchase||"Add to cart":window?.loopPropsUI?.translationData?.widget_out_of_stock_text||"Out of Stock":window?.loopPropsUI?.translationData?.widget_add_to_cart_button_for_subscription||"Add subscription to cart"}function updateButtonInnerHTML(a,b){a.firstElementChild?a.firstElementChild.innerHTML=b:a.innerHTML=b}
function loopFormatMoney(a,b){const c=document.querySelector("#loop-price-money-format").innerText,d=document.querySelector("#loop-price-money_without_currency-format").innerText;a=formatPrice(a,c,d);b&&(a=a.replace("each",""));return a.trim()}function formatPrice(a,b,c){a/=100;return b.includes("0.00")?b.replace("0.00",a.toFixed(2)):b.includes("0,00")?b.replace("0,00",a.toFixed(2).replace(".",",")):b.includes("0")?(c=Number(c.replace("0",a)).toFixed(0),b.replace("0",c)):b}
function getSavedPriceLabel(a){if(!Array.isArray(a)||!a.length)return"";a=a[0];return"percentage"===a.value_type?`Save ${a.value}%`:`Save ${loopFormatMoney(a.value,!0)}`}function updateSellingPlanDescriptionUI({productId:a}){var b=findSelectedVariantLoop(a);const c=window.loopProps?.[a];c?.sellingPlanGroupId&&(a=c?.sellingPlanDefination?.description||"",b=document.querySelector(`#loop-selling-plan-description-${b.id}-${c.sellingPlanGroupId}`),updateSellingPlanDescriptionElement(b,a))}
function updateSellingPlanDescriptionElement(a,b){a&&((a.innerHTML=b)?a.classList.remove("loop-display-none"):a.classList.add("loop-display-none"))}function updatePriceInParentElements({productId:a}){var b=getCurrentPath();window?.loopProps[a]?.product?.handle===b&&(b=findSelectedVariantLoop(a),b=determinePrice(a,b),loopPriceSelectors.push(`.loop-product-${a}`),updatePricesInUI(b))}
function determinePrice(a,b){return(a=window?.loopProps[a]?.sellingPlanAllocation?.price)?loopFormatMoney(a,!0):loopFormatMoney(b.price,!0)}function updatePricesInUI(a){loopPriceSelectors.forEach(b=>{if(b=document.querySelector(b))b.innerHTML=`${a}`})}
function updatePriceInUI({productId:a}){let b=findSelectedVariantLoop(a,window.loopProps[a].selectedVariantId);var c=window.loopProps&&window.loopProps[a]?window.loopProps[a].sellingPlan:{};const {selling_plan_groups:d}=window.loopProps[a]?.product||{},{selling_plan_allocations:f}=b;d.map(g=>{if(Array.isArray(g.selling_plans)&&g.selling_plans.length){let e=g.selling_plans[0];g=f.find(l=>Number(l.selling_plan_id)===Number(e.id))||{};const {selling_plan_group_id:h,per_delivery_price:k}=g;if(g=document.querySelector(`#loop-price-${b.id}-${h}`))g.innerHTML=
loopFormatMoney(k,!0)}});if(c&&c.selling_plan_group_id){const {selling_plan_group_id:g,per_delivery_price:e}=c;if(c=document.querySelector(`#loop-price-${b.id}-${g}`))c.innerHTML=loopFormatMoney(e,!0)}if(a=getLoopSubscriptionContainer(a).querySelector("#loop-price-one-time"))a.innerHTML=loopFormatMoney(b.price,!0)}function log(a){console.log(a)}function logError(a){console.error(a)}
function initializeLoopData(a){window.LoopSubscriptions||(window.LoopSubscriptions={});window.LoopSubscriptions[a]=getProductData(a)}function getProductData(a){a=document.querySelector(`.${productDataClass}-${a}`).textContent;return JSON.parse(a)}function getLoopSubscriptionContainer(a){return document.querySelector(`#${loopSubscriptionContainerId}-${a}`)}function getCurrentPath(){const a=window.location.pathname.split("/");return a[a.length-1]}
function isTouchDevice(){return"ontouchstart"in document.documentElement}
async function getBundleSpgs(a){const b=window.loopProps[a].availableSellingPlanAllocations.map(d=>({selling_plan_group_id:d.selling_plan_group_id,selling_plan_id:d.selling_plan_id}));var c=window.loopProps[a].availableSellingPlanAllocations.map(d=>d.selling_plan_id);c={domain:window.Shopify.shop,sellingPlanIds:c,product_shopify_id:a};try{const d=(await (await fetch(FILTER_BUNDLE_SP_API,{method:"POST",body:JSON.stringify(c),headers:{"Content-Type":"application/json"}})).json()).data;c=[];let f=[];
for(const g of b)d.includes(g.selling_plan_id)?c.push(g.selling_plan_group_id):f.push(g.selling_plan_group_id);window.loopProps[a].bundleSPGS=[...(new Set(c))];window.loopProps[a].nonBundleSPGS=[...(new Set(f))];hideBundleSPG(a)}catch(d){console.error("getBundleSpgs",d)}}
function hideBundleSPG(a){if(!1===window.loopProps?.[a]?.productBundleData?.isBundleProduct){var b=window.loopProps[a];const c=getLoopSubscriptionContainer(a);c&&(b=b.bundleSPGS,b?.length&&(b.forEach(d=>{d=c.querySelectorAll(`#loop-selling_plan_group-${d}`);d?.length&&d.forEach(f=>{f.classList.add("loop-display-none")})}),clickUpdatedSPG(a)))}}
function clickUpdatedSPG(a){showSellingPlanFieldset(a);showLoopPurchaseOptionsLabel(a);const b=window.loopProps[a].selectedVariantId,c=window.loopProps[a].nonBundleSPGS??[];if(0!==c.length&&window.loopPropsUI.byDefaultChooseSubscriptionOption){const d=c[0];getLoopSubscriptionContainer(a).querySelectorAll(`#loop-selling_plan_group-${d}`).forEach(f=>{f.querySelectorAll(`#loop-allocation-${d}`).forEach(g=>{g.querySelectorAll(`#loop-${b}-${d}`).forEach(e=>{e.click()})})})}else defaultSelectOneTimePurchaseOption(b,
a)}async function getBundleDataByProductId(a){return(await (await fetch(`${GET_PRODUCT_BUNDLE_DATA_API}${a}`)).json()).data}function handleBundleWidgetVisibility(a){"SUBSCRIPTION"===window.loopProps[a].productBundleData.purchaseType?hideOneTimePurchaseOption(a):"ONETIME"===window.loopProps[a].productBundleData.purchaseType&&(hideSellingPlanFieldset(a),hideLoopPurchaseOptionsLabel(a),defaultSelectOneTimePurchaseOption(null,a))}
async function processBundleProduct(a){try{const b=await getBundleDataByProductId(a);b&&(window.loopProps[a].productBundleData=b,b.isBundleProduct&&(overrideAddToCartButton(a,b.mapping),handleBundleWidgetVisibility(a),applyBundleDiscount(a),checkAllowCheckoutIfBundle(a)))}catch(b){console.error("processBundleProduct",b)}}
function checkAllowCheckoutIfBundle(a){enableAddToCartBtn(a);var b=window.loopProps[a].selectedVariantId;if(window.loopProps[a]?.productBundleData?.isBundleProduct){var c=window.loopProps[a].productBundleData.mapping[b];b=c?.allowCheckout;if(c=c?.outOfStock){const d=window?.loopPropsUI?.translationData?.widget_out_of_stock_text||"Out of Stock",f=document.querySelector(`[data-loop-product-id="${a}"]`)||document,g=getAddToCartButton(f);g&&setTimeout(()=>{updateButtonInnerHTML(g,d)},500)}b&&!c||disableAddToCartBtn(a)}}
function applyBundleDiscount(a){if(window.loopProps[a]?.productBundleData?.isBundleProduct){var b=window.loopProps[a].productBundleData,c=findSelectedVariantLoop(a,window.loopProps[a].selectedVariantId),d=window.loopProps[a].selectedVariantId,f=b.productVariantDiscountMapping?.[d];if(f){b=(b.mapping?.[d].childProducts).reduce((n,q)=>n+=q.quantity,0);var g=window.Shopify.currency.rate;d=f.find(n=>"ONETIME"==n.purchaseType);var e=f.find(n=>"SUBSCRIPTION"==n.purchaseType),h=0,k=0;f=window.loopProps[a]?.sellingPlanDefination?.price_adjustments?.find(n=>
"price"==n.value_type);h=window.loopProps&&window.loopProps[a]?window.loopProps[a].sellingPlan:{};var {selling_plan_groups:l}=window.loopProps[a]?.product||{},{selling_plan_allocations:r}=c;l.map(n=>{if(Array.isArray(n.selling_plans)&&n.selling_plans.length){let q=n.selling_plans[0];n=r.find(p=>Number(p.selling_plan_id)===Number(q.id))||{};const {selling_plan_group_id:t,per_delivery_price:u}=n;if(n=document.querySelector(`#loop-price-${c.id}-${t}`)){let p=u;e&&("FIXED"===e.bundleDiscountType?(k=Number(e.bundleDiscountValue)*
g,p-=100*k):(k=Number(e.bundleDiscountValue)/100*p,p-=k));n.innerHTML=loopFormatMoney(p,!0)}}});if(h&&h.selling_plan_group_id){const {selling_plan_group_id:n,per_delivery_price:q}=h;if(h=document.querySelector(`#loop-price-${c.id}-${n}`))l=q,e&&("FIXED"===e.bundleDiscountType?(k=Number(e.bundleDiscountValue)*g,k=f?k*b:k,l=(f?l*b:l)-100*k):(k=Number(e.bundleDiscountValue)/100*l,k=f?k*b:k,l=(f?l*b:l)-k)),h.innerHTML=loopFormatMoney(l,!0)}if(l=getLoopSubscriptionContainer(a).querySelector("#loop-price-one-time")){var m=
c.price;d&&("FIXED"===d.bundleDiscountType?(h=Number(d.bundleDiscountValue)*g,m-=100*h):(h=Number(d.bundleDiscountValue)/100*m,m-=h));l.innerHTML=loopFormatMoney(m,!0)}h=getCurrentPath();window?.loopProps[a]?.product?.handle===h&&(l=window?.loopProps[a]?.sellingPlanAllocation?.price,m=c.price,d&&("FIXED"===d.bundleDiscountType?(h=Number(d.bundleDiscountValue)*g,m=(f?m*b:m)-100*(f?h*b:h)):(h=Number(d.bundleDiscountValue)/100*m,m=(f?m*b:m)-(f?h*b:h))),l&&(m=l,e&&("FIXED"===e.bundleDiscountType?(k=Number(e.bundleDiscountValue)*
g,k=f?k*b:k,m=(f?m*b:m)-100*k):(k=Number(e.bundleDiscountValue)/100*m,k=f?k*b:k,m=(f?m*b:m)-k))),loopPriceSelectors.push(`.loop-product-${a}`),updatePricesInUI(loopFormatMoney(m,!0)))}}}function listenLoopCustomEvent(){document.addEventListener("loopAddToCartSuccessEvent",function(a){const b=a.detail.productId;a=a.detail.response;window.location.href="/cart";console.log(`Loop Product ${b} added to cart. Response:`,a)})}
function removeAllEventListeners(a){const b=a.cloneNode(!0);a.parentNode.replaceChild(b,a);return b}function overrideAddToCartButton(a,b){document.querySelectorAll(`[data-loop-product-id="${a}"]`).forEach(c=>{c.querySelectorAll("button").forEach(d=>{d=removeAllEventListeners(d);d.addEventListener("click",f=>{const g=c.getAttribute("data-loop-product-id"),e=document.querySelector(PRODUCT_QUANTITY_SELECTOR);loopHandleAddToCart(f,g,e.value,b)})})})}
async function applyShopifyDiscount(a){try{await fetch(`${window?.Shopify?.routes?.root}discount/${a}`,{method:"GET",headers:{"Content-Type":"application/json"}})}catch(b){enableAddToCartBtn(productId)}}async function createBundleTransaction(a){try{return(await (await fetch(CREATE_BUNDLE_TRANSACTION_API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).json()).loopBundleGuid}catch(b){throw console.error("createBundleTransaction",b),b;}}
function hideOneTimePurchaseOption(a){document.querySelectorAll(`form[data-loop-product-id="${a}"]`).forEach(b=>{b.querySelectorAll(".loop-one-time-purchase-option").forEach(c=>{c.classList.add("loop-display-none")})})}function disableAddToCartBtn(a){document.querySelectorAll(`[data-loop-product-id="${a}"]`).forEach(b=>{b.querySelectorAll("button").forEach(c=>{c.disabled=!0})})}
function enableAddToCartBtn(a){document.querySelectorAll(`[data-loop-product-id="${a}"]`).forEach(b=>{b.querySelectorAll("button").forEach(c=>{c.disabled=!1})})}
function createBundleTransactionPayload(a,b,c){const d=window.loopProps[a].selectedVariantId;a=window.loopProps[a].productBundleData;let f=null,g={};if(c){var e=a?.productVariantDiscountMapping?.[d]?.find(h=>"SUBSCRIPTION"===h.purchaseType);e&&(g=e,f=e.bundleDiscountId)}else if(e=a?.productVariantDiscountMapping?.[d]?.find(h=>"SUBSCRIPTION"!==h.purchaseType))g=e,f=e.bundleDiscountId;return f?{payload:{bundleId:a.bundleId,bundleVariantId:a?.productVariantMapping?.[d],bundleDiscountId:f,sellingPlanId:a?.productVariantSellingPlanMapping?.[c],
productsQuantity:Number(b)},bundleVariantDiscount:g}:{payload:null,bundleVariantDiscount:null}}async function handleBundleTransaction(a,b,c){try{const {payload:d,bundleVariantDiscount:f}=createBundleTransactionPayload(a,b,c),g=await createBundleTransaction(d);g||enableAddToCartBtn(a);return{bundleTransactionId:g,bundleVariantDiscount:f}}catch(d){enableAddToCartBtn(a)}}
function getSelectedSellingPlan(a){let b=null;document.querySelectorAll(`form[data-loop-product-id="${a}"]`).forEach(c=>{c=c.querySelector('input[name="selling_plan"]');c?.value&&(b=Number(c.value))});return b}async function getBundleDiscountAttributes(){const a=await (await fetch(`https://${Shopify.shop}/cart.json`)).json();return a.attributes?._loopBundleDiscountAttributes?JSON.parse(a.attributes._loopBundleDiscountAttributes):{}}
async function createAddToCartPayload(a,b,c,d,f,g){const e={items:[],attributes:{_loopBundleDiscountAttributes:{}}},h=await getBundleDiscountAttributes(),k={};k[a]={discountType:b.bundleDiscountType,discountValue:b.bundleDiscountValue,discountComputedValue:b?c?b.spbpDiscount[c]*f:b.bundleDiscountComputedValue*f:0};e.attributes._loopBundleDiscountAttributes=JSON.stringify({...h,...k});b=g.mapping?.[d].childProducts??bundleVariants[d].childProducts;b?.length&&b.forEach(l=>{e.items.push({id:l.childVariantId,
quantity:l.quantity*f,selling_plan:c,properties:{_bundleId:a,_isPresetBundleProduct:!0}})});return e}async function shopifyAddToCartByLoop(a,b){fetch(`${window.Shopify.routes.root}cart/add.js`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(c=>c.json()).then(async c=>{await dispatchLoopAddCartEvent(b,c,null)}).catch(c=>{console.error("shopifyAddToCartByLoop",c);enableAddToCartBtn(b)})}
async function loopHandleAddToCart(a,b,c,d){a.preventDefault();a.stopPropagation();disableAddToCartBtn(b);a=window.loopProps[b].selectedVariantId;if(d[a].allowCheckout){d=window.loopProps[b].productBundleData;var f=getSelectedSellingPlan(b),{bundleTransactionId:g,bundleVariantDiscount:e}=await handleBundleTransaction(b,c,f);g&&(c=await createAddToCartPayload(g,e,f,a,c,d),await shopifyAddToCartByLoop(c,b))}else console.warn("cannot checkout bundle product"),disableAddToCartBtn(b)}
async function dispatchLoopAddCartEvent(a,b,c){a=new CustomEvent("loopAddToCartSuccessEvent",{detail:{productId:a,response:b}});document.dispatchEvent(a)};
